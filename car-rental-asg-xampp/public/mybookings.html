<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>My Bookings</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <link
      href="https://fonts.googleapis.com/css2?family=Alumni+Sans+Pinstripe:ital@0;1&display=swap"
      rel="stylesheet"
    />
  
  <!-- Stylesheets -->
  <link rel="stylesheet" href="../css/style.css"/>
  <link rel="stylesheet" href="../css/myBookings.css"/>
</head>
<body>
  <!-- Navigation Bar -->
  <nav>
    <ul>
      <li><img src="../css/images/logo.png" alt="Logo"></li>
      <li><a href="main.html">Home</a></li>
      <li><a href="mybookings.html"><u>My Bookings</u></a></li>
      <li><a href="faq.html">FAQ</a></li>
      <li><a href="#" onclick="logout(); return false;">Logout</a></li>
    </ul>
  </nav>

  <main class="bookingsWrap">
    <h1 class="pageTitle">My Bookings</h1>

    <!-- Active Bookings Section -->
    <section class="panel">
      <header class="panelHead">
        <h2>Active bookings</h2>
        <span class="countBadge" id="activeCount">0</span>
      </header>
      <div class="cards" id="activeBookings">
        <div class="empty"><p>Loading...</p></div>
      </div>
    </section>

    <!-- Past Bookings Section -->
    <section class="panel">
      <header class="panelHead">
        <h2>Past bookings</h2>
        <span class="countBadge" id="pastCount">0</span>
      </header>
      <div class="cards" id="pastBookings">
        <div class="empty"><p>Loading...</p></div>
      </div>
    </section>
  </main>

  <script>
    const API_BASE = 'http://localhost/car-rental-asg-xampp/src/api/myBookings.php';
    const customerID = sessionStorage.getItem('customerID');

    // Redirect to login if user is not authenticated
    if (!customerID) {
      alert('Please login first');
      window.location.href = 'login.html';
    }

    function logout() {
      sessionStorage.clear();
      window.location.href = 'login.html';
    }

    function getStatusTag(status, startDate) {
      const today = new Date().toISOString().split('T')[0];
      
      // Ongoing bookings
      if (status === 'Active' || (status === 'Pending' && startDate <= today)) {
        return { class: 'tag-now', label: 'Ongoing' };
      }
      // Upcoming bookings
      if (status === 'Pending' && startDate > today) {
        return { class: 'tag-upcoming', label: 'Upcoming' };
      }
      // Completed bookings
      if (status === 'Completed') {
        return { class: 'tag-done', label: 'Completed' };
      }
      // Cancelled bookings
      if (status === 'Cancelled') {
        return { class: 'tag-cancel', label: 'Canceled' };
      }
      
      // Default fallback
      return { class: '', label: status };
    }

    function getHandoverMethod(deliveryLocation) {
      return (deliveryLocation === 'HQ' || !deliveryLocation) ? 'Pick up' : 'Delivery';
    }

    function formatDate(dateStr) {
      return dateStr.split(' ')[0];
    }

    function renderBookingCard(booking, isPast = false) {
      const statusTag = getStatusTag(booking.rentalStatus, booking.startDate);
      const handoverMethod = getHandoverMethod(booking.deliveryLocation);
      const carName = `${booking.makeName} ${booking.carModel}`;
      const imageUrl = booking.imageURL || '../css/images/default-car.jpg';

      // Show delivery address only if delivery is selected
      const addressHtml = handoverMethod === 'Delivery' 
        ? `<p class="bAddr">Address: ${booking.deliveryLocation}</p>` 
        : '';

      // Different actions for past vs active bookings
      const actionsHtml = isPast
        ? `<a class="btnGhost" href="booking.html?carID=${booking.carID}">Book Again</a>`
        : `<a class="btnGhost" href="booking.html?id=${booking.rentalID}">View</a>
           <button class="btnDanger" type="button" onclick="cancelBooking('${booking.rentalID}')">Cancel</button>`;

      return `
        <article class="card bCard">
          <img class="bImg" src="${imageUrl}" alt="${carName}">
          <div class="bBody">
            <div class="bTop">
              <h3 class="bTitle">${carName}</h3>
              <span class="bTag ${statusTag.class}">${statusTag.label}</span>
            </div>
            <p class="bMeta">
              ${formatDate(booking.startDate)} → ${formatDate(booking.endDate)} · 
              ${booking.days} days · ${handoverMethod}
            </p>
            ${addressHtml}
            <div class="bBottom">
              <div class="bPrice">
                <span>Total</span>
                <strong>B$ ${Math.round(booking.totalPrice)}</strong>
              </div>
              <div class="bActions">
                ${actionsHtml}
              </div>
            </div>
          </div>
        </article>
      `;
    }

    async function loadActiveBookings() {
      const container = document.getElementById('activeBookings');
      const countBadge = document.getElementById('activeCount');

      try {
        // Fetch active bookings from API
        const response = await fetch(`${API_BASE}?action=getActive&customerID=${customerID}`);
        
        // Parse response
        const text = await response.text();
        const data = JSON.parse(text);

        // Render bookings or show empty state
        if (data.success && data.bookings.length > 0) {
          container.innerHTML = data.bookings.map(b => renderBookingCard(b, false)).join('');
          countBadge.textContent = data.bookings.length;
        } else {
          container.innerHTML = '<div class="empty"><p>No active bookings found.</p></div>';
          countBadge.textContent = '0';
        }
      } catch (error) {
        console.error('Error loading active bookings:', error);
        container.innerHTML = '<div class="empty"><p>Error loading bookings. Please try again.</p></div>';
      }
    }

    async function loadPastBookings() {
      const container = document.getElementById('pastBookings');
      const countBadge = document.getElementById('pastCount');

      try {
        // Fetch past bookings from API
        const response = await fetch(`${API_BASE}?action=getPast&customerID=${customerID}`);
        
        // Parse response
        const text = await response.text();
        const data = JSON.parse(text);
        
        // Render bookings or show empty state
        if (data.success && data.bookings.length > 0) {
          container.innerHTML = data.bookings.map(b => renderBookingCard(b, true)).join('');
          countBadge.textContent = data.bookings.length;
        } else {
          container.innerHTML = '<div class="empty"><p>No past bookings found.</p></div>';
          countBadge.textContent = '0';
        }
      } catch (error) {
        console.error('Error loading past bookings:', error);
        container.innerHTML = '<div class="empty"><p>Error loading bookings. Please try again.</p></div>';
      }
    }

    async function cancelBooking(rentalID) {
      // Confirm cancellation with user
      if (!confirm('Are you sure you want to cancel this booking?')) {
        return;
      }

      try {
        // Send cancellation request
        const response = await fetch(`${API_BASE}?action=cancel`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ rentalID, customerID })
        });

        const data = await response.json();

        // Handle response
        if (data.success) {
          alert('Booking cancelled successfully');
          // Reload both sections to reflect changes
          loadActiveBookings();
          loadPastBookings();
        } else {
          alert('Failed to cancel booking: ' + (data.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Cancellation error:', error);
        alert('Error: ' + error.message);
      }
    }

    // ===== PAGE INITIALIZATION =====
    // Load both booking sections when page loads
    document.addEventListener('DOMContentLoaded', () => {
      loadActiveBookings();
      loadPastBookings();
    });
  </script>
</body>
</html>